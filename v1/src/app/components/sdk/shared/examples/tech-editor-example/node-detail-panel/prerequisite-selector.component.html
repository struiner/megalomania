<!-- Prerequisite Selector Component -->
<div 
  class="prerequisite-selector"
  [class.prerequisite-selector--disabled]="isDisabled"
  (clickOutside)="onClickOutside($event)"
  (keydown)="onKeydown($event)">
  
  <!-- Selector Input -->
  <button 
    type="button"
    class="prerequisite-selector__trigger"
    [class.prerequisite-selector__trigger--open]="isDropdownOpen"
    [disabled]="isDisabled"
    (click)="toggleDropdown()"
    [attr.aria-expanded]="isDropdownOpen"
    [attr.aria-haspopup]="true"
    [attr.aria-label]="getSelectedDisplayText()">
    
    <span class="prerequisite-selector__display-text">
      {{ getSelectedDisplayText() }}
    </span>
    
    <span class="prerequisite-selector__arrow" 
          [class.prerequisite-selector__arrow--open]="isDropdownOpen">
      ‚ñº
    </span>
  </button>
  
  <!-- Dropdown Content -->
  <div 
    class="prerequisite-selector__dropdown"
    *ngIf="isDropdownOpen"
    [style.max-height.px]="config.maxHeight">
    
    <!-- Search Input -->
    <div class="prerequisite-selector__search">
      <input 
        #searchInput
        type="text"
        class="prerequisite-selector__search-input"
        [placeholder]="'Search nodes...'"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange(searchTerm)"
        (keydown)="$event.stopPropagation()"
        aria-label="Search prerequisite nodes">
      
      <span class="prerequisite-selector__search-icon">
        üîç
      </span>
    </div>
    
    <!-- Options List -->
    <div class="prerequisite-selector__options" 
         role="listbox"
         [attr.aria-label]="'Available prerequisite nodes'">
      
      <!-- No Results State -->
      <div 
        *ngIf="filteredNodes.length === 0"
        class="prerequisite-selector__no-results">
        <span class="prerequisite-selector__no-results-text">
          {{ searchTerm ? 'No nodes match your search' : 'No available nodes' }}
        </span>
      </div>
      
      <!-- Node Options -->
      <div 
        *ngFor="let nodeData of filteredNodes; let i = index"
        class="prerequisite-selector__option"
        [class.prerequisite-selector__option--selected]="nodeData.isSelected"
        [class.prerequisite-selector__option--invalid]="!nodeData.isValid"
        [class.prerequisite-selector__option--focused]="i === focusedIndex"
        [class.prerequisite-selector__option--disabled]="isNodeDisabled(nodeData)"
        role="option"
        [attr.aria-selected]="nodeData.isSelected"
        [attr.aria-disabled]="isNodeDisabled(nodeData)"
        [attr.data-node-id]="nodeData.id"
        (click)="onPrerequisiteClick(nodeData)"
        (mouseenter)="focusedIndex = i">
        
        <!-- Selection Indicator -->
        <span class="prerequisite-selector__option-check">
          {{ nodeData.isSelected ? '‚úì' : '' }}
        </span>
        
        <!-- Node Info -->
        <div class="prerequisite-selector__option-info">
          <div class="prerequisite-selector__option-name">
            {{ nodeData.name }}
          </div>
          
          <div class="prerequisite-selector__option-meta">
            <span 
              *ngIf="config.showTier"
              class="prerequisite-selector__option-tier">
              {{ getTierDisplay(nodeData.tier) }}
            </span>
            
            <span class="prerequisite-selector__option-id">
              ID: {{ nodeData.id }}
            </span>
          </div>
        </div>
        
        <!-- Validation Message -->
        <span 
          *ngIf="config.showValidation && nodeData.validationMessage"
          class="prerequisite-selector__option-validation"
          [attr.title]="nodeData.validationMessage"
          [attr.aria-label]="nodeData.validationMessage">
          ‚ö†
        </span>
      </div>
    </div>
    
    <!-- Dropdown Footer -->
    <div class="prerequisite-selector__footer">
      <div class="prerequisite-selector__summary">
        <span class="prerequisite-selector__summary-text">
          {{ filteredNodes.length }} available node{{ filteredNodes.length !== 1 ? 's' : '' }}
          <span *ngIf="searchTerm"> matching "{{ searchTerm }}"</span>
        </span>
      </div>
      
      <!-- Clear Search Button -->
      <button 
        *ngIf="searchTerm"
        type="button"
        class="prerequisite-selector__clear-search"
        (click)="onSearchChange(''); $event.stopPropagation()"
        aria-label="Clear search">
        ‚úï
      </button>
    </div>
  </div>
</div>

<!-- Selected Prerequisites Display (when dropdown is closed) -->
<div 
  *ngIf="selectedPrerequisites.length > 0 && !isDropdownOpen"
  class="prerequisite-selector__selected-summary">
  
  <span class="prerequisite-selector__selected-count">
    {{ selectedPrerequisites.length }} prerequisite{{ selectedPrerequisites.length !== 1 ? 's' : '' }} selected
  </span>
  
  <!-- Selected Prerequisites List -->
  <div class="prerequisite-selector__selected-list">
    <span 
      *ngFor="let prereqId of selectedPrerequisites; let last = last"
      class="prerequisite-selector__selected-item">
      {{ (availableNodes.find(n => n.id === prereqId)?.name) || prereqId }}
      <span *ngIf="!last">, </span>
    </span>
  </div>
</div>
